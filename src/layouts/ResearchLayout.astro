---
import "../styles/research.css";
import type { ImageMetadata } from "astro";
import { Github, FileText } from "lucide-astro";
import ViewCounter from "../components/ViewCounter.astro";

interface Author {
	name: string;
	affiliation?: string;
	email?: string;
}

interface Revision {
	date: Date;
	note: string;
}

interface Props {
	title: string;
	abstract?: string;
	date: Date;
	authors?: Author[] | string;
	keywords?: string[];
	revisions?: Revision[];
	codeUrl?: string;
	pdfUrl?: string;
	description?: string;
	image?: ImageMetadata;
	slug?: string;
	workerUrl?: string;
}

const {
	title,
	abstract,
	date,
	authors,
	keywords,
	revisions,
	codeUrl,
	pdfUrl,
	description,
	slug,
	workerUrl,
} = Astro.props;

// must normalize authors to array (if provided)
const authorList: Author[] | undefined = authors
	? typeof authors === "string"
		? [{ name: authors }]
		: authors
	: undefined;

const metaDescription =
	description || (abstract ? abstract.substring(0, 160) + "..." : title);
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const formatDate = (d: Date): string =>
	d.toLocaleDateString("en-GB", {
		day: "numeric",
		month: "short",
		year: "numeric",
	});

const sortedRevisions = revisions?.slice().sort((a, b) => b.date.valueOf() - a.date.valueOf());
const hasRevisions = sortedRevisions && sortedRevisions.length > 0;
const lastRevisionDate = hasRevisions ? sortedRevisions[0].date : null;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="icon" type="image/png" href="/favicon.png" />

		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
			integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV"
			crossorigin="anonymous"
		/>

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Fira+Code:wght@400;500&display=swap"
			rel="stylesheet"
		/>

		<link rel="canonical" href={canonicalURL} />

		<title>{title}</title>
		<meta name="description" content={metaDescription} />

		<!-- OG -->
		<meta property="og:type" content="article" />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={metaDescription} />

		<!-- Twitter -->
		<meta property="twitter:card" content="summary" />
		<meta property="twitter:title" content={title} />
		<meta property="twitter:description" content={metaDescription} />
	</head>

	<body>
		<article class="research">
			<header class="research-header">
				<h1 class="research-title">{title}</h1>

				{
					authorList && authorList.length > 0 && (
						<div class="research-authors">
							{authorList.map((author, i) => (
								<>
									{i > 0 && <span class="author-and">&nbsp;&nbsp;&nbsp;&nbsp;</span>}
									<span class="author">
										<span class="author-name">{author.name}</span>
										{author.affiliation && (
											<span class="author-affiliation">{author.affiliation}</span>
										)}
										{author.email && (
											<span class="author-email">{author.email}</span>
										)}
									</span>
								</>
							))}
						</div>
					)
				}

				<div class="research-date-container">
					{hasRevisions ? (
						<>
							<time class="research-date" datetime={lastRevisionDate!.toISOString()}>
								last revised {formatDate(lastRevisionDate!)}
							</time>
							<span class="date-separator">Â·</span>
							<button class="revision-toggle" aria-expanded="false" aria-controls="revision-history">
								history
							</button>
						</>
					) : (
						<time class="research-date" datetime={date.toISOString()}>
							{formatDate(date)}
						</time>
					)}
				</div>
				{hasRevisions && (
					<div id="revision-history" class="revision-history" hidden>
						<ul>
							{sortedRevisions.map((rev) => (
								<li>
									<span class="revision-date">{formatDate(rev.date)}</span>
									<span class="revision-note">{rev.note}</span>
								</li>
							))}
							<li class="revision-original">
								<span class="revision-date">{formatDate(date)}</span>
								<span class="revision-note">Initial publication</span>
							</li>
						</ul>
					</div>
				)}
				{(codeUrl || pdfUrl) && (
					<div class="research-links">
						{codeUrl && (
							<a href={codeUrl} target="_blank" rel="noopener noreferrer" class="research-link">
								<Github aria-hidden="true" size={16} strokeWidth={1.5} />
								<span>Code</span>
							</a>
						)}
						{pdfUrl && (
							<a href={pdfUrl} target="_blank" rel="noopener noreferrer" class="research-link">
								<FileText aria-hidden="true" size={16} strokeWidth={1.5} />
								<span>Paper</span>
							</a>
						)}
					</div>
				)}
			</header>

			{
				(abstract || (keywords && keywords.length > 0)) && (
					<section class="abstract">
						{abstract && (
							<>
								<h2>Abstract</h2>
								<p>{abstract}</p>
							</>
						)}
						{keywords && keywords.length > 0 && (
							<p class="keywords">
								<strong>Keywords:</strong> {keywords.join(", ")}
							</p>
						)}
					</section>
				)
			}

			<main class="research-content">
				<slot />
			</main>

			<footer class="research-footer">
				<a href="/research">Back to Research</a>
				<span class="separator">|</span>
				<a href="/">sumit.ml</a>
			</footer>
		</article>
		<script>
			const toggle = document.querySelector('.revision-toggle');
			const history = document.getElementById('revision-history');
			if (toggle && history) {
				toggle.addEventListener('click', () => {
					const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
					toggle.setAttribute('aria-expanded', (!isExpanded).toString());
					history.hidden = isExpanded;
				});
			}
		</script>
		{slug && <ViewCounter slug={slug} workerUrl={workerUrl} trackOnly />}
	</body>
</html>
