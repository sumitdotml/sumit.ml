---
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ViewCounter from "../../components/ViewCounter.astro";
import { RESEARCH_BASE_PAGE_DESCRIPTION, SITE_TITLE, WORKER_URL } from "../../consts";
import "../../styles/pages/research.css";

const research = (await getCollection("research"))
	.filter((item) => !item.data.draft)
	.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title={`Research | ${SITE_TITLE}`}
			description={RESEARCH_BASE_PAGE_DESCRIPTION}
		/>
	</head>
	<body>
		<Header />
		<main class="research-page">
			<h1>Research</h1>
			<p class="research-description">
				Technical reports and research writeups
			</p>
			<ul>
				{
					research.map((item) => (
						<li>
							<a href={`/research/${item.id}/`}>
								<h2 class="report-title">{item.data.title}</h2>
							</a>
							<p class="report-abstract">{item.data.abstract}</p>
							<div class="report-meta">
								{(() => {
									const latestDate = item.data.revisions && item.data.revisions.length > 0
										? item.data.revisions.sort((a, b) => b.date.valueOf() - a.date.valueOf())[0].date
										: item.data.date;
									return (
										<time datetime={latestDate.toISOString()}>
											{latestDate.toLocaleDateString("en-US", {
												year: "numeric",
												month: "long",
												day: "numeric",
											})}
										</time>
									);
								})()}
								<ViewCounter slug={`research/${item.id}`} workerUrl={WORKER_URL} readOnly={true} />
							</div>
						</li>
					))
				}
			</ul>
			{
				research.length === 0 && (
					<p class="no-reports">No reports published yet.</p>
				)
			}
		</main>
		<Footer />
	</body>
</html>
